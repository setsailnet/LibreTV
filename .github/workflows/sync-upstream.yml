name: Sync Upstream

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
    # ï¼ˆç›¸å½“äºæ—¥æœ¬æ—¶é—´ (JST) ä¸­åˆ 12 ç‚¹ï¼‰
    - cron: "0 3 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # æˆäºˆå†™å…¥å†…å®¹æƒé™ï¼Œä»¥ä¾¿æ¨é€åˆ°ä»“åº“

jobs:
  sync:
    runs-on: ubuntu-latest # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä¸Šè¿è¡Œ
    steps:
      - name: Checkout repository # æ£€å‡ºä½ çš„ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿è¿›è¡Œåˆå¹¶

      - name: Add upstream remote and fetch # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“å¹¶è·å–æ›´æ–°
        run: |
          git remote add upstream https://github.com/LibreSpark/LibreTV.git || true # å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™å¿½ç•¥é”™è¯¯
          git fetch upstream

      - name: Merge upstream into main (handle conflicts gracefully) # åˆå¹¶ä¸Šæ¸¸çš„ main åˆ†æ”¯åˆ°ä½ çš„ main åˆ†æ”¯
        run: |
          # å°è¯•åˆå¹¶ã€‚å¦‚æœå¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œç”±äºå†²çªï¼‰ï¼Œåˆ™æ‰“å°æ¶ˆæ¯å¹¶ä»¥æˆåŠŸçŠ¶æ€é€€å‡ºï¼Œ
          # è¡¨æ˜éœ€è¦æ‰‹åŠ¨ä»‹å…¥ã€‚
          git merge upstream/main -m "ğŸ”„ Sync from upstream" || {
            echo "Merge failed. Possibly due to conflicts. Manual intervention required.";
            exit 0; # ä»¥æˆåŠŸçŠ¶æ€é€€å‡ºï¼Œé˜²æ­¢å·¥ä½œæµæ˜¾ç¤ºä¸ºå¤±è´¥
          }
        env:
          # è®¾ç½® GIT_COMMITTER_NAME å’Œ GIT_COMMITTER_EMAIL æ¥å®šä¹‰åˆå¹¶æäº¤çš„ä½œè€…ä¿¡æ¯
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com

      - name: Push changes # æ¨é€åˆå¹¶åçš„æ›´æ”¹åˆ°ä½ çš„ä»“åº“
        # åªæœ‰åœ¨åˆå¹¶æˆåŠŸï¼ˆå³æ²¡æœ‰æ‰§è¡Œ exit 0ï¼‰æ—¶ï¼Œè¿™ä¸ªæ­¥éª¤æ‰ä¼šå®é™…æ¨é€æ›´æ”¹
        run: |
          git push origin main
        env:
          # ä½¿ç”¨ GITHUB_TOKEN è¿›è¡Œè®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
